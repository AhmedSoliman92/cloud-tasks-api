name: Deploy Cloud Task API
on:
    push:
      branches: [main, dev]
    workflow_dispatch:

env:
  PYTHON_VERSION: "3.14.2"
jobs:
    lints:
        name: Linting and Code Quality
        runs-on: Ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v5
            
            - name: Python Environment Setup
              uses: ./.github/actions/python-env-setup
              with:
                python-version: ${{ env.PYTHON_VERSION }}
                cache-key-suffix: "preperation-${{ env.PYTHON_VERSION}}"
            - name: Check Import (Isort)
              run: |
                isort flask_app --check-only --diff

            - name: Check Formatting (Black)
              run: |
                black flask_app --check

            - name: Lint with Flake8
              run: |
                flake8 flask_app
    
    tests:
        name: Run Tests
        runs-on: Ubuntu-latest
        needs: lints
        environment: ${{ github.ref_name == 'main' && 'production' || 'development' }}
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v5

            - name: Setup Python Environment
              uses: ./.github/actions/python-env-setup
              with:
                python-version: ${{ env.PYTHON_VERSION }}
                cache-key-suffix: preparation-${{ env.PYTHON_VERSION}}

            - name: Activate PostgreSQL
              run: |
                sudo systemctl start postgresql.service
                sudo -u postgres psql -c 'select 1' || sleep 6
                sudo -u postgres psql -c "ALTER USER postgres PASSWORD '${{ secrets.DB_PASSWORD }}'"
                sudo -u postgres psql -c 'create database ${{ secrets.DB_NAME }}'
            
            - name: Run Tests
              env:
                DB_URL: ${{ secrets.DB_URL }}
                DB_USER: ${{ secrets.DB_USER }}
                DB_PASS: ${{ secrets.DB_PASSWORD }}
                DB_HOST: ${{ secrets.DB_HOST }}
                DB_NAME: ${{ secrets.DB_NAME }}
              working-directory: flask_app
              run: |
                python3 -m pytest